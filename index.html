<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>TNSB Lesson Plan Creator (Table Format)</title>

<script src="https://cdn.tailwindcss.com"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

<!-- Updated pdfmake to a reliable version with working Roboto fonts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.min.js"></script>

<style>
    .hidden { display: none !important; }
    
    /* --- PRINT / PDF STYLING (Matches your Uploaded PDF) --- */
    #content {
        font-family: 'Times New Roman', Times, serif;
        color: #000;
        background: white;
        width: 210mm; 
        min-height: 297mm;
        padding: 15mm;
        margin: 0 auto;
        box-shadow: 0 0 15px rgba(0,0,0,0.1);
        font-size: 12pt;
        line-height: 1.3;
    }

    /* Header Grid */
    .header-grid {
        display: grid;
        grid-template-columns: 180px 1fr;
        gap: 5px;
        margin-bottom: 5px;
    }
    .header-label { font-weight: bold; }

    /* The Main Lesson Plan Table */
    .lp-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
        margin-bottom: 15px;
    }
    .lp-table th, .lp-table td {
        border: 1px solid black;
        padding: 8px;
        vertical-align: top;
        text-align: left;
    }
    .lp-table th {
        background-color: #f3f3f3;
        font-weight: bold;
        text-align: center;
    }
    
    /* Column Widths to match the scan */
    .col-content { width: 20%; }
    .col-specs { width: 15%; }
    .col-experience { width: 45%; }
    .col-eval { width: 20%; }

    /* Activity subsections */
    .activity-header {
        font-weight: bold;
        text-decoration: underline;
        margin-bottom: 4px;
        display: block;
    }

    /* Signatures */
    .signature-section {
        margin-top: 50px;
        display: flex;
        justify-content: space-between;
        font-weight: bold;
    }
</style>
</head>

<body class="min-h-screen bg-slate-100 py-8 px-4 text-slate-800 font-sans">

<!-- UI remains unchanged -->
<div class="max-w-6xl mx-auto">
    <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-indigo-900">AI Lesson Plan Creator</h1>
        <p class="text-sm text-gray-500">Upload Textbook → Fill Details → Get Formatted PDF</p>
    </div>

    <div id="statusBox" class="hidden bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded shadow-sm mx-auto max-w-3xl">
        <p class="font-bold text-yellow-700" id="statusTitle">Processing...</p>
        <p class="text-sm text-yellow-600" id="statusMessage"></p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <div class="bg-white rounded-xl shadow-lg p-6 space-y-5 h-fit">
            
            <div class="p-3 bg-gray-50 rounded border border-gray-200">
                <label class="block text-xs font-bold text-gray-500 uppercase">Groq API Key</label>
                <input type="password" id="apiKeyInput" class="w-full mt-1 px-3 py-2 border rounded text-sm outline-none focus:border-indigo-500" placeholder="Paste gq-... key here" />
                <p class="text-xs text-gray-500 mt-1">Get your free key at <a href="https://console.groq.com/keys" target="_blank" class="underline">console.groq.com</a></p>
            </div>

            <div class="border-t pt-4">
                <label class="block font-bold text-indigo-900 mb-2">1. Upload Textbook Page</label>
                <input type="file" id="pdfFile" accept="application/pdf" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
                
                <div id="pageInputs" class="hidden grid grid-cols-2 gap-2 mt-3">
                    <input type="number" id="fromPage" class="border px-2 py-1 rounded" placeholder="Start Pg" />
                    <input type="number" id="toPage" class="border px-2 py-1 rounded" placeholder="End Pg" />
                </div>
                <button id="runOCR" class="hidden mt-3 w-full bg-indigo-600 text-white py-2 rounded font-bold hover:bg-indigo-700">Extract Text</button>
            </div>

            <div class="border-t pt-4 space-y-3">
                <h3 class="font-bold text-gray-800">2. Teacher Details</h3>
                <input id="studentTeacher" class="w-full px-3 py-2 border rounded text-sm" placeholder="Name of Student Teacher" />
                <input id="guideTeacher" class="w-full px-3 py-2 border rounded text-sm" placeholder="Name of Guide Teacher" />
                <input id="schoolName" class="w-full px-3 py-2 border rounded text-sm" placeholder="School Name" />
            </div>

            <div class="border-t pt-4 space-y-3">
                <h3 class="font-bold text-gray-800">3. Lesson Info</h3>
                <div class="grid grid-cols-2 gap-2">
                    <input id="cls" class="px-3 py-2 border rounded text-sm" placeholder="Class (e.g. VIII)" />
                    <input id="subject" class="px-3 py-2 border rounded text-sm" placeholder="Subject (e.g. English)" />
                </div>
                <input id="lessonTopic" class="w-full px-3 py-2 border rounded text-sm" placeholder="Topic (e.g. Hobby Turns...)" />
                <div class="grid grid-cols-2 gap-2">
                    <input id="unit" class="px-3 py-2 border rounded text-sm" placeholder="Unit (e.g. Prose)" />
                    <input id="duration" class="px-3 py-2 border rounded text-sm" placeholder="Duration (e.g. 45 min)" />
                </div>
                <input id="date" class="w-full px-3 py-2 border rounded text-sm" type="date" />
            </div>

            <button id="generatePlan" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded shadow-lg text-lg flex justify-center items-center gap-2">
                <span>Generate Plan</span>
            </button>
            
            <button onclick="downloadPDF()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded shadow flex justify-center items-center gap-2">
                Download PDF
            </button>
        </div>

        <div class="lg:col-span-2 bg-gray-200 p-4 rounded-xl overflow-auto h-screen">
            <div id="content">
                <div class="text-center text-gray-400 mt-20">
                    <p class="text-xl">Generated Lesson Plan will appear here.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// --- CONFIGURATION ---
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

// --- STATE ---
let ocrText = "";
let globalPlan = null;

// --- UI HELPERS --- (unchanged)

// --- OCR & AI GENERATION LOGIC --- (unchanged from previous version)

// --- RENDERING LOGIC --- (unchanged)

// --- FIXED PDF DOWNLOAD ---
function downloadPDF() {
    if (!globalPlan) {
        alert("Please generate the lesson plan first.");
        return;
    }

    const d = document;
    
    const sTeacher = d.getElementById('studentTeacher').value || '';
    const gTeacher = d.getElementById('guideTeacher').value || '';
    const school = d.getElementById('schoolName').value || '';
    const cls = d.getElementById('cls').value || '';
    const subj = d.getElementById('subject').value || '';
    const topic = d.getElementById('lessonTopic').value || '';
    const unit = d.getElementById('unit').value || '';
    const date = d.getElementById('date').value || '';
    const dur = d.getElementById('duration').value || '';

    const data = globalPlan;

    const docDefinition = {
        pageSize: 'A4',
        pageMargins: [40, 60, 40, 70],  // Approx 15mm sides/top, 25.4mm (1 inch) bottom
        defaultStyle: {
            fontSize: 12,
            lineHeight: 1.3
        },
        content: [
            { text: 'LESSON PLAN', style: 'header' },
            
            {
                columns: [
                    { width: 180, text: 'Name of Student Teacher', bold: true },
                    { text: `: ${sTeacher}` }
                ],
                columnGap: 10,
                margin: [0, 0, 0, 5]
            },
            {
                columns: [
                    { width: 180, text: 'Name of Guide Teacher', bold: true },
                    { text: `: ${gTeacher}` }
                ],
                columnGap: 10,
                margin: [0, 0, 0, 5]
            },
            {
                columns: [
                    { width: 180, text: 'Name of School', bold: true },
                    { text: `: ${school}` }
                ],
                columnGap: 10,
                margin: [0, 0, 0, 15]
            },

            {
                table: {
                    widths: ['*', '*', '*'],
                    body: [
                        [{ text: `Class: ${cls}`, bold: true }, { text: `Subject: ${subj}`, bold: true }, { text: `Topic: ${topic}`, bold: true }],
                        [{ text: `Unit: ${unit}`, bold: true }, { text: `Date: ${date}`, bold: true }, { text: `Duration: ${dur}`, bold: true }]
                    ]
                },
                layout: 'lightHorizontalLines',
                margin: [0, 0, 0, 20]
            },

            { text: 'Motivation / Introduction:', bold: true, margin: [0, 10, 0, 5] },
            { text: data.introduction || '', margin: [0, 0, 0, 20] },

            {
                table: {
                    headerRows: 1,
                    widths: ['20%', '15%', '45%', '20%'],
                    body: [
                        [
                            { text: 'Content', bold: true, alignment: 'center', fillColor: '#f3f3f3' },
                            { text: 'Specifications / Objectives', bold: true, alignment: 'center', fillColor: '#f3f3f3' },
                            { text: 'Learning Experience', bold: true, alignment: 'center', fillColor: '#f3f3f3' },
                            { text: 'Evaluation', bold: true, alignment: 'center', fillColor: '#f3f3f3' }
                        ],
                        ...data.rows.map(row => [
                            row.content || '',
                            row.specifications || '',
                            {
                                stack: [
                                    { text: 'Teacher Activity:', bold: true, decoration: 'underline', margin: [0, 5, 0, 5] },
                                    row.teacher_activity || '',
                                    { text: 'Student Activity:', bold: true, decoration: 'underline', margin: [0, 10, 0, 5] },
                                    row.student_activity || ''
                                ],
                                lineHeight: 1.4
                            },
                            row.evaluation || ''
                        ])
                    ]
                },
                layout: {
                    hLineWidth: () => 1,
                    vLineWidth: () => 1,
                    paddingLeft: () => 8,
                    paddingRight: () => 8,
                    paddingTop: () => 8,
                    paddingBottom: () => 8
                }
            },

            { text: 'Follow Up / Assignment:', bold: true, margin: [0, 30, 0, 5] },
            { text: data.follow_up || '', margin: [0, 0, 0, 50] },

            {
                columns: [
                    { text: 'Signature of Student Teacher', bold: true },
                    { text: 'Signature of Guide Teacher', bold: true, alignment: 'right' }
                ]
            }
        ],
        styles: {
            header: {
                fontSize: 20,
                bold: true,
                alignment: 'center',
                decoration: 'underline',
                margin: [0, 0, 0, 20]
            }
        }
    };

    pdfMake.createPdf(docDefinition).download("LessonPlan.pdf");
}
</script>
</body>
</html>
