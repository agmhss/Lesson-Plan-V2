<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>TNSB Lesson Plan Creator (Table Format)</title>

<script src="https://cdn.tailwindcss.com"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.min.js"></script>

<style>
    .hidden { display: none !important; }
    
    /* --- PRINT / PDF STYLING --- */
    #content {
        font-family: 'Times New Roman', Times, serif;
        color: #000;
        background: white;
        width: 210mm; 
        min-height: 297mm;
        padding: 15mm;
        margin: 0 auto;
        box-shadow: 0 0 15px rgba(0,0,0,0.1);
        font-size: 12pt;
        line-height: 1.3;
    }

    /* Header Grid */
    .header-grid {
        display: grid;
        grid-template-columns: 180px 1fr;
        gap: 5px;
        margin-bottom: 5px;
    }
    .header-label { font-weight: bold; }

    /* Table Styles */
    .lp-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
        margin-bottom: 15px;
    }
    .lp-table th, .lp-table td {
        border: 1px solid black;
        padding: 8px;
        vertical-align: top;
        text-align: left;
    }
    .lp-table th {
        background-color: #f3f3f3;
        font-weight: bold;
        text-align: center;
    }
    
    .col-content { width: 20%; }
    .col-specs { width: 15%; }
    .col-experience { width: 45%; }
    .col-eval { width: 20%; }

    .activity-header {
        font-weight: bold;
        text-decoration: underline;
        margin-bottom: 4px;
        display: block;
    }

    .signature-section {
        margin-top: 50px;
        display: flex;
        justify-content: space-between;
        font-weight: bold;
    }
</style>
</head>

<body class="min-h-screen bg-slate-100 py-8 px-4 text-slate-800 font-sans">

<div class="max-w-6xl mx-auto">
    <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-indigo-900">AI Lesson Plan Creator</h1>
        <p class="text-sm text-gray-500">Upload Textbook → Fill Details → Get Formatted PDF</p>
    </div>

    <div id="statusBox" class="hidden bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded shadow-sm mx-auto max-w-3xl">
        <p class="font-bold text-yellow-700" id="statusTitle">Processing...</p>
        <p class="text-sm text-yellow-600" id="statusMessage"></p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <div class="bg-white rounded-xl shadow-lg p-6 space-y-5 h-fit">
            
            <div class="p-3 bg-gray-50 rounded border border-gray-200">
                <label class="block text-xs font-bold text-gray-500 uppercase">Groq API Key</label>
                <input type="password" id="apiKeyInput" class="w-full mt-1 px-3 py-2 border rounded text-sm outline-none focus:border-indigo-500" placeholder="Paste gq-... key here" />
                <p class="text-xs text-gray-500 mt-1">Get your free key at <a href="https://console.groq.com/keys" target="_blank" class="underline">console.groq.com</a></p>
            </div>

            <div class="border-t pt-4">
                <label class="block font-bold text-indigo-900 mb-2">1. Upload Textbook Page (PDF)</label>
                <input type="file" id="pdfFile" accept="application/pdf" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
                
                <!-- Fixed: Removed 'hidden' class so they appear immediately after file selection -->
                <div id="pageInputs" class="grid grid-cols-2 gap-2 mt-3">
                    <input type="number" id="fromPage" min="1" class="border px-3 py-2 rounded text-sm" placeholder="Start Page (e.g. 1)" required />
                    <input type="number" id="toPage" min="1" class="border px-3 py-2 rounded text-sm" placeholder="End Page (e.g. 5)" required />
                </div>
                <button id="runOCR" class="mt-3 w-full bg-indigo-600 text-white py-2 rounded font-bold hover:bg-indigo-700">Extract Text from Selected Pages</button>
            </div>

            <div class="border-t pt-4 space-y-3">
                <h3 class="font-bold text-gray-800">2. Teacher Details</h3>
                <input id="studentTeacher" class="w-full px-3 py-2 border rounded text-sm" placeholder="Name of Student Teacher" />
                <input id="guideTeacher" class="w-full px-3 py-2 border rounded text-sm" placeholder="Name of Guide Teacher" />
                <input id="schoolName" class="w-full px-3 py-2 border rounded text-sm" placeholder="School Name" />
            </div>

            <div class="border-t pt-4 space-y-3">
                <h3 class="font-bold text-gray-800">3. Lesson Info</h3>
                <div class="grid grid-cols-2 gap-2">
                    <input id="cls" class="px-3 py-2 border rounded text-sm" placeholder="Class (e.g. VIII)" />
                    <input id="subject" class="px-3 py-2 border rounded text-sm" placeholder="Subject (e.g. English)" />
                </div>
                <input id="lessonTopic" class="w-full px-3 py-2 border rounded text-sm" placeholder="Topic (e.g. Lessons in Life)" />
                <div class="grid grid-cols-2 gap-2">
                    <input id="unit" class="px-3 py-2 border rounded text-sm" placeholder="Unit (e.g. Unit 6 Poem)" />
                    <input id="duration" class="px-3 py-2 border rounded text-sm" placeholder="Duration (e.g. 45 min)" />
                </div>
                <input id="date" class="w-full px-3 py-2 border rounded text-sm" type="date" />
            </div>

            <button id="generatePlan" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded shadow-lg text-lg flex justify-center items-center gap-2">
                <span>Generate Plan</span>
            </button>
            
            <button onclick="downloadPDF()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded shadow flex justify-center items-center gap-2">
                Download PDF
            </button>
        </div>

        <div class="lg:col-span-2 bg-gray-200 p-4 rounded-xl overflow-auto h-screen">
            <div id="content">
                <div class="text-center text-gray-400 mt-20">
                    <p class="text-xl">Generated Lesson Plan will appear here.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// --- CONFIGURATION ---
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

// --- STATE ---
let ocrText = "";
let globalPlan = null;

// --- UI HELPERS ---
function setStatus(title, msg, type='process') {
    const box = document.getElementById('statusBox');
    if(!title) { box.classList.add('hidden'); return; }
    box.classList.remove('hidden');
    document.getElementById('statusTitle').textContent = title;
    document.getElementById('statusMessage').textContent = msg;
    box.className = type === 'error' 
        ? "bg-red-50 border-l-4 border-red-400 p-4 mb-6 rounded shadow-sm mx-auto max-w-3xl"
        : "bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded shadow-sm mx-auto max-w-3xl";
}

// --- 1. OCR LOGIC (Now works as soon as file is selected) ---
document.getElementById("pdfFile").addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (file) {
        // Page inputs and button are now always visible after file selection
        document.getElementById("pageInputs").style.display = "grid";
        document.getElementById("runOCR").style.display = "block";
    }
});

document.getElementById("runOCR").addEventListener("click", async () => {
    const file = document.getElementById("pdfFile").files[0];
    const from = parseInt(document.getElementById("fromPage").value);
    const to = parseInt(document.getElementById("toPage").value);
    
    if (!file) return alert("Please upload a PDF file first.");
    if (!from || !to || from > to) return alert("Please enter valid Start and End page numbers.");

    try {
        setStatus("Processing OCR", "Loading PDF and extracting text...");
        const buffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(buffer).promise;
        
        let textAcc = "";
        for (let i = from; i <= to; i++) {
            setStatus("OCR Scanning", `Processing page ${i} of ${to}...`);
            const page = await pdf.getPage(i);
            const viewport = page.getViewport({ scale: 2 });
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            await page.render({ canvasContext: ctx, viewport }).promise;
            
            const res = await Tesseract.recognize(canvas, 'eng', {
                logger: m => console.log(m)  // Optional: for debugging progress
            });
            textAcc += res.data.text + "\n\n";
        }
        ocrText = textAcc.trim();
        setStatus("Success", "Text extracted successfully! Now fill details and click Generate Plan.");
        setTimeout(() => setStatus(null), 4000);
    } catch (e) {
        console.error(e);
        setStatus("Error", "OCR failed. Check console or try a clearer PDF.", "error");
    }
});

// --- 2. AI GENERATION & RENDERING (unchanged) ---
// ... [Same as previous working version]

document.getElementById("generatePlan").addEventListener("click", async () => {
    // ... [same AI call code]
    // After getting plan:
    globalPlan = plan;
    renderLessonPlan(plan);
});

// renderLessonPlan function (same as before)

function renderLessonPlan(data) {
    // ... [same HTML rendering code]
}

// --- 3. PDF DOWNLOAD (pdfmake - working) ---
function downloadPDF() {
    if (!globalPlan) {
        alert("Please generate the lesson plan first.");
        return;
    }

    // ... [same pdfmake docDefinition as last working version]

    pdfMake.createPdf(docDefinition).download("LessonPlan.pdf");
}
</script>
</body>
</html>
